# Environnement du projet

## Environnement Python

Toutes les analyses hors QGIS (scripts et notebooks), je m'appui sur un **environnement virtuel dedié au projet**. Celui-ci est décrit dans un fichier `requirements.yml` (placé le dossier `envs/` du projet). Ce fichier liste toutes les bibliothèques et leurs versions. 

```{admonition} Important
:class: important
Un environnement virtuel permet d’isoler les dépendances d’un projet de celles des autres projets ou du système. Ainsi, deux projets peuvent utiliser des versions différentes d’une même bibliothèque sans conflit.

*Référence : [Python Documentation - Virtual Environments](https://docs.python.org/3/tutorial/venv.html)*
```

Cela garantit :

* la **reproductibilité** (mêmes résultats sur n’importe quelle machine),
* la **portabilité** (facilité à partager ou réinstaller l’environnement).


## Outils de gestion d’environnement

Plusieurs gestionnaires d’environnement existent :  

- **[venv](https://docs.python.org/3/library/venv.html)** - outil natif de Python, simple et léger pour créer des environnements virtuels.  
  *Référence : Python Software Foundation, [Python 3 Documentation - venv](https://docs.python.org/3/library/venv.html)*  

- **[Conda](https://docs.conda.io/projects/conda/en/latest/index.html)** - gestionnaire d’environnements et de paquets multiplateforme, particulièrement adapté aux bibliothèques scientifiques et géospatiales.  
  *Référence : Anaconda, Inc., [Conda Documentation](https://docs.conda.io/projects/conda/en/latest/index.html)*  

- **[Mamba](https://mamba.readthedocs.io/en/latest/)** - alternative à Conda, compatible mais beaucoup plus rapide grâce à son moteur en C++.  
  *Référence : Mamba Developers, [Mamba Documentation](https://mamba.readthedocs.io/en/latest/)*  

- **[Poetry](https://python-poetry.org/docs/)** - gestionnaire moderne de dépendances et d’emballage (packaging) pour Python.  
  *Référence : Python Poetry Project, [Poetry Documentation](https://python-poetry.org/docs/)*  

- **[Pipenv](https://pipenv.pypa.io/en/latest/)** - outil de gestion combinant `pip` et `virtualenv`, historiquement populaire mais moins utilisé aujourd’hui.  
  *Référence : Python Packaging Authority (PyPA), [Pipenv Documentation](https://pipenv.pypa.io/en/latest/)*  

- **[Docker](https://docs.docker.com/)** - solution plus lourde, basée sur des conteneurs, garantissant une portabilité et une reproductibilité complètes.  
  *Référence : Docker, Inc., [Docker Documentation](https://docs.docker.com/)*  


```{admonition} Recommandation d’environnement
:class: tip
Dans ce projet, je recommande **Conda** (ou **Mamba**) car ce sont les solutions les plus simples et robustes pour installer et gérer les bibliothèques géospatiales (*GDAL*, *PROJ*, *Rasterio*, *Fiona*, *Shapely*), qui nécessitent souvent des dépendances systèmes (bibliothèques C/C++) complexes à compiler avec `pip` seul.

Cette recommandation est appuyée par plusieurs documentations officielles :

- **GeoPandas** précise :  
  > “We recommend using conda to install GeoPandas and its dependencies, as it handles the C libraries required by Fiona, GDAL, and Pyproj.”  
  — *[GeoPandas Documentation — Installation](https://geopandas.org/en/stable/getting_started/install.html)*  

- **Rasterio** souligne également :  
  > “If you can use conda to install Rasterio, you’ll find it much easier to install and manage than building from source with pip.”  
  — *[Rasterio Documentation — Installation](https://rasterio.readthedocs.io/en/latest/installation.html)*  

- **Fiona** confirme la difficulté d’installation via `pip` et recommande Conda pour la gestion automatique des dépendances :  
  > “Installing Fiona from source requires the GDAL library and headers. It is easier to install using conda.”  
  — *[Fiona Documentation — Installation](https://fiona.readthedocs.io/en/latest/installation.html)*  

```

```{admonition} Pour aller plus loin
:class: note
Consultez le guide *"Comparing Python environment management tools"* (Real Python, 2023) :  
[https://realpython.com/python-virtual-environments-a-primer/](https://realpython.com/python-virtual-environments-a-primer/)
```


## Installation de Conda/Mamba

1. **Installer Miniforge ou Mambaforge** (recommandé) ou Miniconda :

   * macOS Apple Silicon (M1/M2/M3) → installeur **ARM64**
   * macOS Intel → installeur **x86_64**
   * Windows → installeur **x86_64**

2. **Ouvrir un terminal** :

   * Windows → *Anaconda Prompt*, *Miniforge Prompt* ou *PowerShell*
   * macOS/Linux → application *Terminal*

3. **Initialiser conda** (à faire une seule fois sur macOS/Linux) :

   ```bash
   conda init zsh   # si vous utilisez zsh (par défaut sur macOS récents)
   conda init bash  # sinon
   ```

   → Fermez et rouvrez le terminal.

4. **Installer mamba** si nécessaire :

   ```bash
   conda install -n base -c conda-forge mamba
   ```

5. **Configurer conda-forge comme canal principal** (conseillé pour la géo) :

   ```bash
   conda config --add channels conda-forge
   conda config --set channel_priority strict
   ```

## Création de l’environnement virtuel

Depuis un terminal, placez-vous dans le dossier racine du projet et lancez :

```bash
conda env create -f requirements.yml  # ou mamba env create -f requirements.yml
```

Cela installe automatiquement un environnement nommé **`geo_env`**.

*Pré-requis :*

* Avoir installé Conda (via [Anaconda](https://www.anaconda.com/download) ou [Miniconda](https://docs.conda.io/en/latest/miniconda.html)).

* Être dans le dossier du projet contenant `requirements.yml`.

## Mise à jour de l’environnement

Pour mettre à jour l'environnement `geo_env` existant :

  ```bash
  mamba env update -n geo_env -f requirements.yml --prune
  ```

  (l’option `--prune` supprime les dépendances devenues inutiles)

On peut **tout** faire avec `conda` en remplaçant `mamba` par `conda` dans les commandes.

## Gestion au quotidien

* **Activer / désactiver**

  ```bash
  mamba activate geo_env   # ou conda activate geo_env
  mamba deactivate         # ou conda deactivate
  ```

* **Lister les environnements disponibles**

  ```bash
  conda env list
  ```

## Utiliser l’environnement dans Jupyter

Pour exécuter les notebooks avec l’environnement `geo_env`, ajoutez-le à Jupyter :

```bash
python -m ipykernel install --user --name geo_env --display-name "Python (geo_env)"
```

Ensuite, dans Jupyter Notebook/Lab, choisissez le noyau **Python (geo_env)**.


## Modifier ou réparer l’environnement

* **Ajouter un paquet** :

  ```bash
  mamba install -n geo_env <nom-du-paquet> -c conda-forge
  ```

* **Installer via pip (au besoin)** :

  ```bash
  python -m pip install <nom-du-paquet>
  ```

* **Exporter les changements dans `requirements.yml`** :

  ```bash
  mamba env export -n geo_env --no-builds > requirements.yml
  ```

* **Supprimer puis recréer l’environnement** :

  ```bash
  mamba remove -n geo_env --all
  mamba env create -f requirements.yml
  ```
Pour la gestion de l'environement avec conda je recommande [Gérer son environnement avec Conda](https://gricad-doc.univ-grenoble-alpes.fr/hpc/softenv/conda/#:~:text=Conda%20est%20un%20syst%C3%A8me%20de,environnements%20sur%20votre%20ordinateur%20local.)

## Liste des paquets et versions

Voici le description complète de l'environnement utilisé dans le projet (fichier `requirements.yml`, priorité **conda-forge** pour les libs géospatiales). 

````{dropdown} **Cliquez ici pour afficher / masquer la liste des paquets**
<br>

```yaml
name: geo_env
channels:
  - conda-forge
  - defaults
dependencies:
  - python=3.10
  - pip
  - numpy
  - pandas
  - geopandas
  - shapely
  - fiona
  - pyproj
  - openpyxl
  - rtree
  - gdal
  - rasterio
  - scikit-learn
  - statsmodels
  - jupyter
  - jupyterlab
  - ipykernel
  - tqdm
  - matplotlib
  - seaborn
  - contextily
  - networkx
  - momepy
  - tobler
  - esda
  - splot
  - libpysal
  - pysal
  - dask
  - xarray
  - rioxarray

  - pip:
      - osmium==4.1.1
      - osmnx==1.7.1
      - folium==0.14.0
      - rasterstats==0.19.0
      - keplergl==0.3.2
      - myst-nb==1.0.0
      - myst-parser==2.0.0
      - jupyter-book
      - sphinxcontrib-mermaid==1.0.0
```
````

```{admonition} Conseil
:class: success

On pense à **activer `geo_env`** à chaque session pour bénéficier des bonnes versions de bibliothèques.

```


